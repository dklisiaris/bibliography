# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

$(".home").ready ->
  # Instantiate the Bloodhound suggestion engine
  suggestions = new Bloodhound(
    datumTokenizer: (datum) ->
      Bloodhound.tokenizers.whitespace datum.value

    queryTokenizer: Bloodhound.tokenizers.whitespace
    limit: 10
    remote:
      url: "/autocomplete?query=%QUERY"
      filter: (suggestions) ->
        
        # Map the remote source JSON array to a JavaScript object array
        $.map suggestions, (suggestion) ->
          value: suggestion    
  )

  # Initialize the Bloodhound suggestion engine
  suggestions.initialize()

  # Instantiate the Typeahead UI
  $("#remote .typeahead").typeahead null,
    displayKey: "value"
    source: suggestions.ttAdapter()


vex.defaultOptions.className = 'vex-theme-plain'
vex.dialog.defaultOptions.showCloseButton = true;
vex.dialog.buttons.YES.text = <%="'#{I18n.t('save')}'"%>
vex.dialog.buttons.NO.text = <%="'#{I18n.t('cancel')}'"%>

@manageCollections = (content, book_id) ->
  was_checked = []
  vex.dialog.open
    message: null
    input: content    
    afterOpen: ($vexContent) ->
      # Fetch json data about this book's collections
      console.log 'vexOpen'
      $('.vex-dialog-input .collections-checkboxes').hide()
      $('.vex-dialog-input .fa-spin').show()      
      $.ajax(url: '/books/'+book_id+'/collections').done (response) ->        
        $.each response, (index, collection) ->          
          $('.vex-dialog-input #collection-'+collection.id).prop('checked', true)
          was_checked.push(collection.id)
        $('.vex-dialog-input .fa-spin').hide()
        $('.vex-dialog-input .collections-checkboxes').show()          
    afterClose: ->
      # Change whatever needs change in current screen
      console.log 'vexClose'    
    callback: (value) ->
      # Save changes            
      is_checked = []
      $.each value, (key, value) ->
        is_checked.push(parseInt(key.split("-").slice(-1)[0])) if value == "on"     
      
      request_data =
        to_add: $(is_checked).not(was_checked).get();
        to_remove: $(was_checked).not(is_checked).get();

      # console.log request_data
      # $.post('/books/'+book_id+'/collections', request_data)    
      
